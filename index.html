<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Диспетчер 24 для ТСЖ</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<style>
  body { font-family: Arial, sans-serif; background-color: #f0f8ff; color: #003366; margin: 20px; }
  h1 { color: #004080; text-align: center; }
  #main-screen { max-width: 600px; margin: 0 auto; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 0 8px rgba(0,64,128,0.2); }
  label { display: block; margin: 6px 0 3px; font-weight: bold; }
  select, textarea, button, input { width: 100%; padding: 8px; margin-bottom: 10px; border-radius: 4px; border: 1px solid #99c2ff; background-color: #e6f0ff; color: #003366; font-size: 14px; box-sizing: border-box; }
  select:focus, textarea:focus, input:focus { background-color: #cce0ff; outline: none; border-color: #3366cc; }
  button { cursor: pointer; border: none; background-color: #3366cc; color: white; font-weight: bold; transition: background-color 0.3s; }
  button:hover:not(:disabled) { background-color: #003366; }
  button:disabled { background-color: #99c2ff; cursor: not-allowed; }
  .request-item { border: 1px solid #99c2ff; padding: 10px; margin-bottom: 10px; border-radius: 5px; background-color: #f9fbff; }
  .status { font-weight: bold; color: #004080; }
  .comments { margin-top: 5px; font-size: 13px; background: #dbe9ff; padding: 5px; border-radius: 4px; max-height: 100px; overflow-y: auto; }
  .comment { margin-bottom: 3px; }
  #notification { background: #fffae6; border: 1px solid #ffe58f; color: #856404; padding: 10px; margin-bottom: 15px; border-radius: 4px; display: none; }
  /* Вкладки */
  .tabs { display: flex; justify-content: center; margin-bottom: 20px; }
  .tab-button { padding: 10px 20px; border: none; background: #99c2ff; color: #003366; cursor: pointer; font-weight: bold; border-radius: 5px 5px 0 0; margin: 0 5px; }
  .tab-button.active { background: #3366cc; color: white; }
  .tab-content { display: none; }
  .tab-content.active { display: block; }
  /* Кнопка помощь */
  #helpButton {
    background-color: #99c2ff;
    color: #003366;
    font-weight: bold;
    cursor: pointer;
    border: none;
    padding: 10px 15px;
    border-radius: 4px;
    margin-top: 10px;
    width: auto;
  }
  #helpButton:hover {
    background-color: #668cff;
  }
</style>
</head>
<body>
<h1>Диспетчер 24 для ТСЖ</h1>
<div id="main-screen">

  <div class="tabs">
    <button class="tab-button active" data-tab="formTab">Новая заявка</button>
    <button class="tab-button" data-tab="listTab">Мои заявки</button>
  </div>

  <div id="notification"></div>

  <div id="formTab" class="tab-content active">
    <form id="requestForm" novalidate>
      <label for="type">Тип заявки:</label>
      <select id="type" name="type" required>
        <option value="repair">Ремонт</option>
        <option value="complaint">Жалоба</option>
        <option value="other">Другое</option>
      </select>

      <label for="description">Описание:</label>
      <textarea id="description" name="description" required placeholder="Опишите проблему"></textarea>

      <button type="submit" id="submitBtn">Отправить</button>
    </form>

    <button id="helpButton" type="button" onclick="showHelp()">Помощь</button>
  </div>

  <div id="listTab" class="tab-content">
    <h2>Мои заявки</h2>
    <div id="requestsList"></div>
  </div>

</div>

<script>
  // Firebase config и инициализация
  const firebaseConfig = {
    apiKey: "AIzSyBpCysz2c3SnWOUTLpf2JburDdgujMaktc",
    authDomain: "courseworktsj.firebaseapp.com",
    projectId: "courseworktsj",
    storageBucket: "courseworktsj.firebasestorage.app",
    messagingSenderId: "578999928624",
    appId: "1:578999928624:web:dcffcb1c5d49bbd11faaf5"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  window.Telegram.WebApp.ready();

  const form = document.getElementById('requestForm');
  const submitBtn = document.getElementById('submitBtn');
  const requestsList = document.getElementById('requestsList');
  const notification = document.getElementById('notification');

  const userId = window.Telegram.WebApp.initDataUnsafe.user?.id || 'unknown';

  const typeTranslations = {
    repair: 'Ремонт',
    complaint: 'Жалоба',
    other: 'Другое'
  };

  // Обработчик вкладок
  document.querySelectorAll('.tab-button').forEach(button => {
    button.addEventListener('click', () => {
      const tab = button.getAttribute('data-tab');
      document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
      button.classList.add('active');
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      document.getElementById(tab).classList.add('active');

      if (tab === 'listTab') {
        listenRequests(); // Запуск подписки на заявки
      }
    });
  });

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const type = form.type.value;
    const description = form.description.value.trim();
    if (!description) {
      alert('Пожалуйста, введите описание.');
      form.description.focus();
      return;
    }
    submitBtn.disabled = true;
    submitBtn.textContent = 'Отправка...';

    try {
      // Добавление заявки в базу данных
      const docRef = await db.collection('requests').add({
        type,
        description,
        userId,  // Добавляем userId, чтобы заявка была привязана к конкретному пользователю
        status: 'new',
        comments: [],
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });

      form.reset();
      showNotification('Заявка успешно отправлена!');
      // Переключаемся на вкладку "Мои заявки" и сразу обновляем список
      document.querySelector('[data-tab="listTab"]').click();

      // Обновляем список заявок, добавив только что отправленную заявку
      listenRequests();

    } catch (error) {
      alert('Ошибка при отправке заявки: ' + error.message);
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = 'Отправить';
    }
  });

  function showNotification(message) {
    notification.textContent = message;
    notification.style.display = 'block';
    setTimeout(() => {
      notification.style.display = 'none';
    }, 4000);
  }

  // Подписка на заявки пользователя (реальное время)
  function listenRequests() {
    return db.collection('requests')
      .where('userId', '==', userId)  // Фильтруем заявки по userId
      .orderBy('timestamp', 'desc')
      .onSnapshot(snapshot => {
        if (snapshot.empty) {
          requestsList.innerHTML = '<p>Заявок нет.</p>';
          return;
        }
        renderRequests(snapshot.docs);  // Рендерим заявки
      });
  }

  // Функция для рендеринга списка заявок
  function renderRequests(docs) {
    requestsList.innerHTML = ''; // Очищаем текущий список перед добавлением новых данных
    docs.forEach(doc => {
      const data = doc.data();
      const requestElement = document.createElement('div');
      requestElement.classList.add('request-item');
      requestElement.innerHTML = `
        <p><strong>Тип заявки:</strong> ${typeTranslations[data.type]}</p>
        <p><strong>Описание:</strong> ${data.description}</p>
        <p><strong>Статус:</strong> <span class="status">${data.status}</span></p>
        <div class="comments">
          ${data.comments.map(comment => `<p class="comment">${comment}</p>`).join('')}
        </div>
      `;
      requestsList.appendChild(requestElement);
    });
  }
</script>
</body>
</html>
